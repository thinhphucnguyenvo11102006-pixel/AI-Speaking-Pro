<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IELTS Speaking AI Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col items-center justify-center">

    <div class="w-full max-w-md bg-white h-full sm:h-[90vh] sm:rounded-2xl shadow-2xl flex flex-col overflow-hidden relative">
        <header class="bg-indigo-600 text-white p-4 flex items-center justify-between shadow-md z-10">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-indigo-600 font-bold text-xl"><i class="fa-solid fa-graduation-cap"></i></div>
                <div>
                    <h1 class="font-bold text-lg">IELTS Examiner</h1>
                    <p class="text-xs text-indigo-200 flex items-center gap-1"><span class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span> Online</p>
                </div>
            </div>
            <button onclick="location.reload()" class="text-white hover:text-gray-200"><i class="fa-solid fa-rotate-right"></i></button>
        </header>

        <div id="chatBox" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50 scrollbar-hide">
            <div class="flex gap-3">
                <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 flex-shrink-0"><i class="fa-solid fa-robot"></i></div>
                <div class="bg-white border border-gray-200 p-3 rounded-2xl rounded-tl-none shadow-sm max-w-[85%]">
                    <p class="text-sm text-gray-800">Hello! I'm your AI Examiner. Click the microphone button to start.</p>
                </div>
            </div>
        </div>

        <div id="statusIndicator" class="hidden absolute bottom-24 left-1/2 transform -translate-x-1/2 bg-black/70 text-white px-4 py-1 rounded-full text-xs backdrop-blur-sm">
            <i class="fa-solid fa-spinner fa-spin mr-2"></i> Processing...
        </div>

        <div class="p-4 bg-white border-t border-gray-100 flex items-center justify-center relative">
            <button id="micBtn" class="w-16 h-16 rounded-full bg-indigo-600 hover:bg-indigo-700 text-white text-2xl shadow-lg transition-all duration-300 flex items-center justify-center focus:outline-none group">
                <i class="fa-solid fa-microphone group-hover:scale-110 transition-transform"></i>
            </button>
            <button id="stopBtn" class="hidden w-16 h-16 rounded-full bg-red-500 hover:bg-red-600 text-white text-2xl shadow-lg animate-pulse flex items-center justify-center">
                <i class="fa-solid fa-stop"></i>
            </button>
            <p class="absolute bottom-1 text-[10px] text-gray-400">Powered by Gemini & Whisper</p>
        </div>
    </div>

    <script>
        let mediaRecorder;
        let audioChunks = [];
        let chatHistory = "";
        let globalStream = null;

        const micBtn = document.getElementById('micBtn');
        const stopBtn = document.getElementById('stopBtn');
        const chatBox = document.getElementById('chatBox');
        const statusInd = document.getElementById('statusIndicator');

        const scrollToBottom = () => { chatBox.scrollTop = chatBox.scrollHeight; }

        // --- H√ÄM ƒê·ªåC GI·ªåNG N√ìI (M·ªöI TH√äM) ---
        function speakText(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel(); // D·ª´ng c√¢u c≈©
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-GB'; // Gi·ªçng Anh
                utterance.rate = 0.9;     // T·ªëc ƒë·ªô
                window.speechSynthesis.speak(utterance);
            }
        }

        function addMessage(text, sender, isError = false) {
            const div = document.createElement('div');
            if (sender === 'user') {
                div.className = "flex gap-3 flex-row-reverse";
                div.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-600 flex-shrink-0"><i class="fa-solid fa-user"></i></div>
                    <div class="bg-indigo-600 text-white p-3 rounded-2xl rounded-tr-none shadow-sm max-w-[85%]">
                        <p class="text-sm">${text}</p>
                        ${isError ? '<span class="block mt-1 text-xs bg-red-500/20 px-2 py-0.5 rounded text-red-100">‚ö†Ô∏è Pronunciation Check</span>' : ''}
                    </div>`;
            } else {
                div.className = "flex gap-3";
                div.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 flex-shrink-0"><i class="fa-solid fa-robot"></i></div>
                    <div class="bg-white border border-gray-200 p-3 rounded-2xl rounded-tl-none shadow-sm max-w-[85%]">
                        <p class="text-sm text-gray-800">${text}</p>
                    </div>`;
            }
            chatBox.appendChild(div);
            scrollToBottom();
        }

        async function initMicrophone() {
            if (globalStream && globalStream.active) return globalStream;
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                globalStream = stream;
                return stream;
            } catch (err) { alert("Please allow Microphone access!"); return null; }
        }

        micBtn.onclick = async () => {
            const stream = await initMicrophone();
            if (!stream) return;
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
            mediaRecorder.onstop = sendAudioToBackend;
            mediaRecorder.start();
            micBtn.classList.add('hidden'); stopBtn.classList.remove('hidden');
        };

        stopBtn.onclick = () => {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
            stopBtn.classList.add('hidden'); micBtn.classList.remove('hidden');
            statusInd.classList.remove('hidden');
        };

        async function sendAudioToBackend() {
            await new Promise(r => setTimeout(r, 100));
            if (audioChunks.length === 0) { statusInd.classList.add('hidden'); return; }

            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            const formData = new FormData();
            formData.append("file", audioBlob, "input.webm");
            formData.append("history_context", chatHistory);

            try {
                const response = await fetch('http://127.0.0.1:8000/process-audio', { method: 'POST', body: formData });
                const data = await response.json();
                statusInd.classList.add('hidden');

                let userText = data.user_text_analyzed;
                const hasError = userText.includes("[PRONUNCIATION ERROR");
                if (hasError) userText = userText.split("[PRONUNCIATION ERROR")[0];
                addMessage(userText, 'user', hasError);

                if(data.examiner_feedback) {
                    const fbDiv = document.createElement('div');
                    fbDiv.className = "flex justify-center my-2";
                    fbDiv.innerHTML = `<div class="bg-yellow-50 border border-yellow-200 text-yellow-800 text-xs px-3 py-2 rounded-lg shadow-sm">üìù ${data.examiner_feedback}</div>`;
                    chatBox.appendChild(fbDiv);
                }

                addMessage(data.examiner_question, 'ai');
                
                // üî• ƒê·ªåC TO C√ÇU TR·∫¢ L·ªúI üî•
                speakText(data.examiner_question);

                chatHistory += `User: ${data.user_text_analyzed}\nExaminer: ${data.examiner_question}\n`;

            } catch (error) {
                console.error(error);
                statusInd.innerHTML = "‚ùå Error!";
                setTimeout(() => statusInd.classList.add('hidden'), 3000);
            }
        }
    </script>
</body>
</html>